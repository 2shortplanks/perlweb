#!/bin/sh

if test -z $CBROOT
 then
  echo FATAL ERROR: \$CBROOT not set
  exit 
fi

if test ! -z $CBROOTLOCAL 
 then
   cd $CBROOTLOCAL
else
   cd $CBROOT
fi


LOG_PATH=`$CBROOT/bin/perl -MCombust::Config -e 'print Combust::Config->new->log_path'`
WORK_PATH=`$CBROOT/bin/perl -MCombust::Config -e 'print Combust::Config->new->work_path'`

if test -e $CBROOTLOCAL/bin/httpd_setup -a -x $CBROOTLOCAL/bin/httpd_setup; then
   if ! $CBROOTLOCAL/bin/httpd_setup; then
      echo ERROR: httpd_setup failed; exit
   fi
fi

# TODO: change this to check if the httpd is still running every second
mkdir -p $WORK_PATH/htdocs && mkdir -p $WORK_PATH/ctpl && mkdir -p $LOG_PATH && \
rm -fr $WORK_PATH/ctpl/* && \
$CBROOT/bin/make_configs && \
$CBROOT/apache/bin/apachectl configtest && \
$CBROOT/apache/bin/apachectl stop && sleep 6 && $CBROOT/apache/bin/apachectl start

if test -e $CBROOTLOCAL/bin/httpd_cleanup -a -x $CBROOTLOCAL/bin/httpd_cleanup; then
   $CBROOTLOCAL/bin/httpd_cleanup || echo WARNING: httpd_cleanup failed
fi
