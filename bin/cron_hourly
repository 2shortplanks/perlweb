#!/bin/sh

# grr.  argh 
if [ -z $CBROOT ];
then
    CBROOT=/home/newweb
fi

targetpath=$CBROOT/var/rss/

# should probably be tmp/ ... or we should change all the tmp/ stuff to be var/
mkdir -p $targetpath

function getrss () {
    target="$1.rss"
    targettemp="$CBROOT/tmp/${target}.new"
    url=$2

    /usr/bin/lwp-request \
      $url > ${targettemp}

    if [ $? -eq 0 ]; then
      mv $targettemp $targetpath/$target
    fi

}

getrss "useperl" "http://use.perl.org/index.rss";
getrss "cpanrecent" "http://search.cpan.org/recent.rdf?desc=1";
getrss "perlcom" "http://www.perl.com/pace/perlnews.rdf";
getrss "perl-foundation" "http://www.perlfoundation.org/news/tpf_rss_10.rss"
getrss "noc" "http://log.perl.org/index.rdf"
getrss "cpanratings" "http://log.perl.org/cpanratings/index.rdf"

function getcpanstats () {
    target="cpan.dat"
    targettemp="$CBROOT/tmp/cpan.dat.new"

    echo "mb : mirrors : authors : modules" > $targettemp
    
    /usr/bin/lwp-request http://www.cpan.org/index.html |
    perl -ne 'm!(\d+) MB (\d+) mirrors<br/>(\d+) authors (\d+) modules!i && print qq!$1 : $2 : $3 : $4\n!' >> $targettemp

    if [ $? -eq 0 ]; then
      mv $targettemp $targetpath/$target
    fi
}

getcpanstats

echo 'delete from combust_cache where expire < NOW();' | $CBROOT/bin/cmysql combust


